name: Gemini Code Review
on:
  workflow_call:
    inputs:
      prompt:
        description: "Review prompt text"
        required: false
        type: string
        default: |
          Review this PR's changes. Respond in Japanese.

          Use this EXACT format:

          ## Review Summary
          - Critical: <count>
          - Major: <count>
          - Minor: <count>

          ## Findings

          ### [CRITICAL] <title>
          - File: <path>
          - Line: <number or range>
          - Issue: <description>
          - Fix: <suggested fix>

          ### [MAJOR] <title>
          (same format as above)

          ### [MINOR] <title>
          (same format as above)

          Categories:
          - CRITICAL: Bugs, crashes, security vulnerabilities, data loss
          - MAJOR: Logic errors, missing error handling, test gaps
          - MINOR: Style issues, naming, documentation

          If no issues found:
          ## Review Summary
          - Critical: 0
          - Major: 0
          - Minor: 0

          No issues found.
      model:
        description: "Gemini model to use"
        required: false
        type: string
        default: "gemini-2.5-flash"
      max_diff_chars:
        description: "Maximum diff characters to send to Gemini"
        required: false
        type: number
        default: 100000
    secrets:
      GEMINI_API_KEY:
        required: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install google-genai

      - name: Run Gemini review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          REVIEW_PROMPT: ${{ inputs.prompt }}
          GEMINI_MODEL: ${{ inputs.model }}
          MAX_DIFF_CHARS: ${{ inputs.max_diff_chars }}
        run: |
          git diff -U10 "$BASE_SHA" "$HEAD_SHA" > /tmp/diff.txt

          python - <<'PYEOF'
          import os, sys
          from google import genai
          from google.genai import types

          with open("/tmp/diff.txt") as f:
              diff = f.read()

          if not diff.strip():
              print("No diff found, skipping review.")
              with open("/tmp/review.txt", "w") as f:
                  f.write("No changes to review.")
              sys.exit(0)

          max_chars = int(os.environ.get("MAX_DIFF_CHARS", "100000"))
          original_len = len(diff)
          truncated = False
          if original_len > max_chars:
              diff = diff[:max_chars]
              truncated = True
              print(f"Diff truncated from {original_len} to {max_chars} characters.")

          prompt = os.environ.get("REVIEW_PROMPT", "Review this PR's changes. Respond in Japanese.")
          model = os.environ.get("GEMINI_MODEL", "gemini-2.5-flash")

          try:
              client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])
              response = client.models.generate_content(
                  model=model,
                  contents=f"## PR Diff:\n```\n{diff}\n```\n\n{prompt}",
                  config=types.GenerateContentConfig(
                      system_instruction="You are a code review assistant reviewing pull request changes.",
                      temperature=0.0,
                  ),
              )
              review_text = response.text
          except Exception as e:
              review_text = f"Gemini API error: {e}"
              print(f"Error calling Gemini API: {e}", file=sys.stderr)

          if truncated:
              review_text += "\n\n> **Note**: Diff was truncated due to size. Review may be incomplete."

          with open("/tmp/review.txt", "w") as f:
              f.write(review_text)
          print(review_text)
          PYEOF

          BODY=$(cat <<EOF
          # Code Review by Gemini

          $(cat /tmp/review.txt)
          EOF
          )
          gh pr comment "$PR_NUMBER" --body "$BODY"
